#
# Copyright (c) 2025, GD32-MCU-IOT Organization
#
# SPDX-License-Identifier: Apache-2.0
#
# GD32 Mirror Repository CI Workflow
# ä¸“ä¸º GD32-MCU-IOT/gd32_rt-thread é•œåƒä»“åº“è®¾è®¡çš„CIæµç¨‹
#

name: GD32 BSP CI Test

on:
  # PRè§¦å‘ - è‡ªåŠ¨æµ‹è¯•å—å½±å“çš„BSP
  pull_request:
    branches:
      - master
    paths:
      - 'bsp/gd32/**'
      - '!bsp/gd32/**/README.md'
      - '!bsp/gd32/**/docs/**'
      - '.github/workflows/gd32_mirror_ci.yml'
      
  # Pushåˆ°master - å…¨é‡æµ‹è¯•ï¼ˆå¯é€‰ï¼‰
  push:
    branches:
      - master
    paths:
      - 'bsp/gd32/**'
      - '.github/workflows/gd32_mirror_ci.yml'
      
  # æ‰‹åŠ¨è§¦å‘ - çµæ´»æ§åˆ¶æµ‹è¯•èŒƒå›´
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'æµ‹è¯•æ¨¡å¼ (all=å…¨éƒ¨BSP, changed=ä»…å˜æ›´çš„BSP, single=å•ä¸ªBSP)'
        required: true
        default: 'changed'
        type: choice
        options:
          - all
          - changed
          - single
      target_bsp:
        description: 'ç›®æ ‡BSPï¼ˆsingleæ¨¡å¼ä¸‹ä½¿ç”¨ï¼Œä¾‹å¦‚ï¼šgd32407v-startï¼‰'
        required: false
        type: string
      architecture:
        description: 'GD32æ¶æ„ï¼ˆall=å…¨éƒ¨, arm=ä»…ARM, risc-v=ä»…RISC-Vï¼‰'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - arm
          - risc-v

# å¹¶å‘æ§åˆ¶ - åŒä¸€PRçš„æ–°æäº¤ä¼šå–æ¶ˆæ—§çš„è¿è¡Œ
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  #==============================================================================
  # Job 1: åˆ†æå˜æ›´å¹¶ç”Ÿæˆæµ‹è¯•çŸ©é˜µ
  #==============================================================================
  analyze-changes:
    runs-on: ubuntu-22.04
    name: ğŸ” åˆ†æGD32 BSPå˜æ›´
    outputs:
      test_matrix: ${{ steps.generate-matrix.outputs.matrix }}
      test_count: ${{ steps.generate-matrix.outputs.count }}
      library_changed: ${{ steps.detect-changes.outputs.library_changed }}
      
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: æ£€æµ‹æ–‡ä»¶å˜æ›´
        id: detect-changes
        run: |
          echo "=== æ£€æµ‹GD32 BSPå˜æ›´ ==="
          
          # ç¡®å®šåŸºå‡†åˆ†æ”¯
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_REF="origin/${{ github.base_ref }}"
          elif [ "${{ github.event_name }}" = "push" ]; then
            BASE_REF="HEAD^"
          else
            BASE_REF="origin/master"
          fi
          
          echo "Base ref: $BASE_REF"
          
          # æ£€æµ‹ libraries å˜æ›´
          LIBRARY_CHANGED=false
          if git diff --name-only $BASE_REF HEAD | grep -q "bsp/gd32/.*/libraries/"; then
            LIBRARY_CHANGED=true
            echo "âœ… GD32 libraries ç›®å½•æœ‰å˜æ›´ - å°†æµ‹è¯•æ‰€æœ‰ç›¸å…³BSP"
          fi
          
          echo "library_changed=$LIBRARY_CHANGED" >> $GITHUB_OUTPUT
          
          # è·å–å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨
          CHANGED_FILES=$(git diff --name-only $BASE_REF HEAD | grep "bsp/gd32/" || true)
          echo "$CHANGED_FILES" > /tmp/changed_files.txt
          
          if [ -n "$CHANGED_FILES" ]; then
            echo "å˜æ›´çš„æ–‡ä»¶ï¼š"
            echo "$CHANGED_FILES"
          else
            echo "âš ï¸ æœªæ£€æµ‹åˆ°GD32ç›¸å…³æ–‡ä»¶å˜æ›´"
          fi
          
      - name: ç”Ÿæˆæµ‹è¯•çŸ©é˜µ
        id: generate-matrix
        run: |
          python3 << 'EOF'
          import json
          import os
          import re
          from pathlib import Path
          
          # GD32 ARM BSPåˆ—è¡¨ï¼ˆåŸºäºå½“å‰ä»“åº“ï¼‰
          ARM_BSPS = [
              "gd32103c-eval", "gd32105c-eval", "gd32105r-start", "gd32107c-eval",
              "gd32205r-start", "gd32207i-eval", "gd32303c-start", "gd32303e-eval",
              "gd32305r-start", "gd32307e-start", "gd32407v-lckfb", "gd32407v-start",
              "gd32450z-eval", "gd32470i-eval", "gd32470z-lckfb", "gd32527I-eval",
              "gd32e230-lckfb", "gd32e503v-eval", "gd32e517z-eval",
              "gd32h759i-eval", "gd32h759i-start", "gd32h75ey-eval"
          ]
          
          # GD32 RISC-V BSPåˆ—è¡¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          RISCV_BSPS = [
              # æ ¹æ®å®é™…æƒ…å†µæ·»åŠ  RISC-V BSP
          ]
          
          # è¯»å–è¾“å…¥å‚æ•°
          event_name = os.getenv('GITHUB_EVENT_NAME', 'pull_request')
          test_mode = os.getenv('INPUT_TEST_MODE', 'changed')
          target_bsp = os.getenv('INPUT_TARGET_BSP', '')
          architecture = os.getenv('INPUT_ARCHITECTURE', 'all')
          library_changed = os.getenv('LIBRARY_CHANGED', 'false') == 'true'
          
          print(f"äº‹ä»¶ç±»å‹: {event_name}")
          print(f"æµ‹è¯•æ¨¡å¼: {test_mode}")
          print(f"æ¶æ„é€‰æ‹©: {architecture}")
          print(f"librarieså˜æ›´: {library_changed}")
          
          # ç”Ÿæˆå€™é€‰BSPåˆ—è¡¨
          candidate_bsps = []
          if architecture == 'all':
              candidate_bsps = ARM_BSPS + RISCV_BSPS
          elif architecture == 'arm':
              candidate_bsps = ARM_BSPS
          elif architecture == 'risc-v':
              candidate_bsps = RISCV_BSPS
          
          # æ ¹æ®æ¨¡å¼å†³å®šæµ‹è¯•å“ªäº›BSP
          test_bsps = []
          
          if test_mode == 'single' and target_bsp:
              # å•BSPæ¨¡å¼
              if target_bsp in candidate_bsps:
                  test_bsps = [target_bsp]
                  print(f"âœ… å•BSPæµ‹è¯•æ¨¡å¼: {target_bsp}")
              else:
                  print(f"âš ï¸ æŒ‡å®šçš„BSP '{target_bsp}' ä¸åœ¨å€™é€‰åˆ—è¡¨ä¸­")
                  
          elif test_mode == 'all':
              # å…¨éƒ¨BSPæ¨¡å¼
              test_bsps = candidate_bsps
              print(f"âœ… å…¨éƒ¨BSPæµ‹è¯•æ¨¡å¼: {len(test_bsps)} ä¸ªBSP")
              
          else:
              # å˜æ›´æ£€æµ‹æ¨¡å¼
              if library_changed:
                  # librarieså˜æ›´å½±å“æ‰€æœ‰BSP
                  test_bsps = candidate_bsps
                  print(f"âœ… librarieså˜æ›´ - æµ‹è¯•æ‰€æœ‰ {len(test_bsps)} ä¸ªBSP")
              else:
                  # åˆ†æå…·ä½“å˜æ›´çš„BSP
                  try:
                      with open('/tmp/changed_files.txt', 'r') as f:
                          changed_files = f.read().strip().split('\n')
                  except:
                      changed_files = []
                  
                  affected_bsps = set()
                  for file_path in changed_files:
                      if not file_path or file_path == '':
                          continue
                      
                      # åŒ¹é… bsp/gd32/arm/XXX/ æˆ– bsp/gd32/risc-v/XXX/
                      match = re.match(r'bsp/gd32/(arm|risc-v)/([^/]+)/', file_path)
                      if match:
                          arch = match.group(1)
                          bsp_name = match.group(2)
                          
                          # æ’é™¤éBSPç›®å½•
                          if bsp_name not in ['libraries', 'docs', 'tools', 'scripts']:
                              if bsp_name in candidate_bsps:
                                  affected_bsps.add(bsp_name)
                                  print(f"  æ£€æµ‹åˆ°å˜æ›´: {arch}/{bsp_name}")
                  
                  test_bsps = sorted(list(affected_bsps))
                  
                  if test_bsps:
                      print(f"âœ… æ£€æµ‹åˆ° {len(test_bsps)} ä¸ªBSPéœ€è¦æµ‹è¯•")
                  else:
                      print("â„¹ï¸ æœªæ£€æµ‹åˆ°BSPå˜æ›´ï¼ˆå¯èƒ½æ˜¯æ–‡æ¡£æˆ–é…ç½®æ–‡ä»¶ï¼‰")
          
          # ç”Ÿæˆmatrix JSON
          if test_bsps:
              # ç¡®å®šæ¶æ„å’Œå·¥å…·é“¾
              matrix_data = []
              for bsp in test_bsps:
                  if bsp in ARM_BSPS:
                      matrix_data.append({
                          "bsp": bsp,
                          "arch": "arm",
                          "toolchain": "gcc-arm-none-eabi"
                      })
                  elif bsp in RISCV_BSPS:
                      matrix_data.append({
                          "bsp": bsp,
                          "arch": "risc-v",
                          "toolchain": "riscv-none-elf"
                      })
              
              matrix = {"include": matrix_data}
          else:
              matrix = {"include": []}
          
          # è¾“å‡ºåˆ°GitHub Actions
          with open(os.getenv('GITHUB_OUTPUT'), 'a') as f:
              f.write(f"matrix={json.dumps(matrix)}\n")
              f.write(f"count={len(test_bsps)}\n")
          
          print(f"\nç”Ÿæˆçš„æµ‹è¯•çŸ©é˜µ: {json.dumps(matrix, indent=2)}")
          print(f"æ€»æµ‹è¯•æ•°é‡: {len(test_bsps)}")
          EOF
        env:
          INPUT_TEST_MODE: ${{ github.event.inputs.test_mode || 'changed' }}
          INPUT_TARGET_BSP: ${{ github.event.inputs.target_bsp }}
          INPUT_ARCHITECTURE: ${{ github.event.inputs.architecture || 'all' }}
          LIBRARY_CHANGED: ${{ steps.detect-changes.outputs.library_changed }}
      
      - name: æ˜¾ç¤ºæµ‹è¯•è®¡åˆ’
        run: |
          echo "### ğŸ“‹ GD32 BSPæµ‹è¯•è®¡åˆ’" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **æµ‹è¯•æ•°é‡**: ${{ steps.generate-matrix.outputs.count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Librarieså˜æ›´**: ${{ steps.detect-changes.outputs.library_changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  #==============================================================================
  # Job 2: å¹¶è¡Œç¼–è¯‘æµ‹è¯•
  #==============================================================================
  build-test:
    runs-on: ubuntu-22.04
    needs: analyze-changes
    if: needs.analyze-changes.outputs.test_count > 0
    name: ğŸ”¨ ç¼–è¯‘ ${{ matrix.arch }}/${{ matrix.bsp }}
    
    strategy:
      fail-fast: false
      max-parallel: 10
      matrix: ${{ fromJson(needs.analyze-changes.outputs.test_matrix) }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          submodules: recursive
          
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq scons libncurses5-dev build-essential
          pip install --quiet requests pyyaml
          git config --global http.postBuffer 524288000
          
      - name: ç¼“å­˜ARMå·¥å…·é“¾
        if: matrix.arch == 'arm'
        id: cache-arm-toolchain
        uses: actions/cache@v4
        with:
          path: /opt/gcc-arm-none-eabi-10.3-2021.10
          key: ${{ runner.os }}-gcc-arm-10.3-2021.10-v1
          
      - name: ä¸‹è½½ARMå·¥å…·é“¾
        if: matrix.arch == 'arm' && steps.cache-arm-toolchain.outputs.cache-hit != 'true'
        run: |
          echo "ğŸ“¥ ä¸‹è½½ ARM GCC å·¥å…·é“¾..."
          wget -q https://developer.arm.com/-/media/Files/downloads/gnu-rm/10.3-2021.10/gcc-arm-none-eabi-10.3-2021.10-x86_64-linux.tar.bz2
          sudo tar -xjf gcc-arm-none-eabi-10.3-2021.10-x86_64-linux.tar.bz2 -C /opt
          rm gcc-arm-none-eabi-10.3-2021.10-x86_64-linux.tar.bz2
          
      - name: ç¼“å­˜RISC-Vå·¥å…·é“¾
        if: matrix.arch == 'risc-v'
        id: cache-riscv-toolchain
        uses: actions/cache@v4
        with:
          path: /opt/riscv-none-elf
          key: ${{ runner.os }}-riscv-none-elf-v1
          
      - name: ä¸‹è½½RISC-Vå·¥å…·é“¾
        if: matrix.arch == 'risc-v' && steps.cache-riscv-toolchain.outputs.cache-hit != 'true'
        run: |
          echo "ğŸ“¥ ä¸‹è½½ RISC-V GCC å·¥å…·é“¾..."
          # æ ¹æ®å®é™…éœ€è¦ä¿®æ”¹ä¸‹è½½é“¾æ¥
          wget -q https://github.com/xpack-dev-tools/riscv-none-elf-gcc-xpack/releases/download/v13.2.0-2/xpack-riscv-none-elf-gcc-13.2.0-2-linux-x64.tar.gz
          sudo mkdir -p /opt/riscv-none-elf
          sudo tar -xzf xpack-riscv-none-elf-gcc-13.2.0-2-linux-x64.tar.gz -C /opt
          sudo mv /opt/xpack-riscv-none-elf-gcc-13.2.0-2 /opt/riscv-none-elf
          rm xpack-riscv-none-elf-gcc-13.2.0-2-linux-x64.tar.gz
          
      - name: é…ç½®ç¼–è¯‘ç¯å¢ƒ
        run: |
          if [ "${{ matrix.arch }}" = "arm" ]; then
            export RTT_EXEC_PATH=/opt/gcc-arm-none-eabi-10.3-2021.10/bin
            export PATH=/opt/gcc-arm-none-eabi-10.3-2021.10/bin:$PATH
            arm-none-eabi-gcc --version
          elif [ "${{ matrix.arch }}" = "risc-v" ]; then
            export RTT_EXEC_PATH=/opt/riscv-none-elf/bin
            export PATH=/opt/riscv-none-elf/bin:$PATH
            riscv-none-elf-gcc --version
          fi
          
          echo "RTT_EXEC_PATH=$RTT_EXEC_PATH" >> $GITHUB_ENV
          echo "RTT_ROOT=$(pwd)" >> $GITHUB_ENV
          echo "RTT_CC=gcc" >> $GITHUB_ENV
          
      - name: ç¼–è¯‘BSP - ${{ matrix.arch }}/${{ matrix.bsp }}
        timeout-minutes: 20
        run: |
          set -e
          
          BSP_PATH="bsp/gd32/${{ matrix.arch }}/${{ matrix.bsp }}"
          
          if [ ! -d "$BSP_PATH" ]; then
            echo "âŒ BSPç›®å½•ä¸å­˜åœ¨: $BSP_PATH"
            exit 1
          fi
          
          cd "$BSP_PATH"
          
          echo "========================================="
          echo "ç¼–è¯‘ GD32 BSP: ${{ matrix.bsp }}"
          echo "æ¶æ„: ${{ matrix.arch }}"
          echo "å·¥ä½œç›®å½•: $(pwd)"
          echo "RTT_ROOT: $RTT_ROOT"
          echo "RTT_EXEC_PATH: $RTT_EXEC_PATH"
          echo "========================================="
          
          # æ­¥éª¤1: é…ç½®BSP
          echo ""
          echo "ğŸ“ æ­¥éª¤1: é…ç½®BSP..."
          if [ -f "Kconfig" ]; then
            scons --pyconfig-silent
          else
            echo "âš ï¸ æœªæ‰¾åˆ°Kconfigæ–‡ä»¶ï¼Œè·³è¿‡é…ç½®æ­¥éª¤"
          fi
          
          # æ­¥éª¤2: æ›´æ–°è½¯ä»¶åŒ…ï¼ˆå¦‚æœéœ€è¦ï¼‰
          echo ""
          echo "ğŸ“¦ æ­¥éª¤2: æ›´æ–°è½¯ä»¶åŒ…..."
          if [ -f "packages/Kconfig" ] || grep -q "PKG_" .config 2>/dev/null; then
            python $RTT_ROOT/tools/menuconfig.py --silent || true
            scons --pyconfig-silent || true
          else
            echo "â„¹ï¸ æœªæ£€æµ‹åˆ°è½¯ä»¶åŒ…é…ç½®ï¼Œè·³è¿‡"
          fi
          
          # æ­¥éª¤3: ç¼–è¯‘
          echo ""
          echo "ğŸ”¨ æ­¥éª¤3: å¼€å§‹ç¼–è¯‘..."
          scons -j$(nproc) --verbose
          
          # æ­¥éª¤4: éªŒè¯ç¼–è¯‘äº§ç‰©
          echo ""
          echo "âœ… æ­¥éª¤4: éªŒè¯ç¼–è¯‘äº§ç‰©..."
          
          ARTIFACTS_FOUND=false
          for artifact in rtthread.bin rtthread.elf rtthread.hex; do
            if [ -f "$artifact" ]; then
              echo "  âœ“ æ‰¾åˆ°: $artifact ($(stat -c%s $artifact) bytes)"
              ARTIFACTS_FOUND=true
            fi
          done
          
          if [ "$ARTIFACTS_FOUND" = false ]; then
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°ç¼–è¯‘äº§ç‰©"
            ls -la
            exit 1
          fi
          
          # æ˜¾ç¤ºä»£ç å¤§å°ç»Ÿè®¡
          if [ -f "rtthread.elf" ]; then
            echo ""
            echo "ğŸ“Š ä»£ç å¤§å°ç»Ÿè®¡:"
            if command -v arm-none-eabi-size &> /dev/null; then
              arm-none-eabi-size rtthread.elf
            elif command -v riscv-none-elf-size &> /dev/null; then
              riscv-none-elf-size rtthread.elf
            fi
          fi
          
          echo ""
          echo "========================================="
          echo "âœ… ${{ matrix.bsp }} ç¼–è¯‘æˆåŠŸ!"
          echo "========================================="
          
      - name: ä¸Šä¼ ç¼–è¯‘äº§ç‰©
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.arch }}-${{ matrix.bsp }}
          path: |
            bsp/gd32/${{ matrix.arch }}/${{ matrix.bsp }}/rtthread.bin
            bsp/gd32/${{ matrix.arch }}/${{ matrix.bsp }}/rtthread.elf
            bsp/gd32/${{ matrix.arch }}/${{ matrix.bsp }}/rtthread.hex
            bsp/gd32/${{ matrix.arch }}/${{ matrix.bsp }}/rtthread.map
          retention-days: 7
          if-no-files-found: warn
          compression-level: 9

  #==============================================================================
  # Job 3: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
  #==============================================================================
  report:
    runs-on: ubuntu-22.04
    needs: [analyze-changes, build-test]
    if: always() && needs.analyze-changes.outputs.test_count > 0
    name: ğŸ“Š ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
    
    steps:
      - name: æ£€å‡ºä»£ç ï¼ˆè·å–ç‰ˆæœ¬ä¿¡æ¯ï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          
      - name: ä¸‹è½½æ‰€æœ‰ç¼–è¯‘äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
        run: |
          echo "# ğŸ”¨ GD32 BSP CIæµ‹è¯•æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“‹ æµ‹è¯•ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| **æµ‹è¯•æ—¶é—´** | $(date +'%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| **è§¦å‘äº‹ä»¶** | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **æäº¤SHA** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Librarieså˜æ›´** | ${{ needs.analyze-changes.outputs.library_changed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **è®¡åˆ’æµ‹è¯•æ•°é‡** | ${{ needs.analyze-changes.outputs.test_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ğŸ“Š ç¼–è¯‘ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| # | æ¶æ„ | BSP | çŠ¶æ€ | äº§ç‰©å¤§å° |" >> $GITHUB_STEP_SUMMARY
          echo "|---|------|-----|------|----------|" >> $GITHUB_STEP_SUMMARY
          
          counter=1
          success_count=0
          fail_count=0
          total_size=0
          
          # éå†äº§ç‰©ç›®å½•
          if [ -d "artifacts" ]; then
            for dir in artifacts/*/; do
              if [ -d "$dir" ]; then
                artifact_name=$(basename "$dir")
                
                # è§£ææ¶æ„å’ŒBSPåç§°
                arch=$(echo "$artifact_name" | cut -d'-' -f1)
                bsp=$(echo "$artifact_name" | cut -d'-' -f2-)
                
                # æ£€æŸ¥ç¼–è¯‘äº§ç‰©
                bin_file="$dir/rtthread.bin"
                elf_file="$dir/rtthread.elf"
                
                if [ -f "$bin_file" ] || [ -f "$elf_file" ]; then
                  # è®¡ç®—å¤§å°
                  size=0
                  if [ -f "$bin_file" ]; then
                    size=$(stat -c%s "$bin_file")
                  elif [ -f "$elf_file" ]; then
                    size=$(stat -c%s "$elf_file")
                  fi
                  
                  # æ ¼å¼åŒ–å¤§å°
                  if [ $size -lt 1024 ]; then
                    size_str="${size}B"
                  elif [ $size -lt 1048576 ]; then
                    size_kb=$((size / 1024))
                    size_str="${size_kb}KB"
                  else
                    size_mb=$((size / 1048576))
                    size_str="${size_mb}MB"
                  fi
                  
                  echo "| $counter | \`$arch\` | \`$bsp\` | âœ… **æˆåŠŸ** | $size_str |" >> $GITHUB_STEP_SUMMARY
                  success_count=$((success_count + 1))
                  total_size=$((total_size + size))
                else
                  echo "| $counter | \`$arch\` | \`$bsp\` | âŒ **å¤±è´¥** | - |" >> $GITHUB_STEP_SUMMARY
                  fail_count=$((fail_count + 1))
                fi
                
                counter=$((counter + 1))
              fi
            done
          fi
          
          # ç»Ÿè®¡ä¿¡æ¯
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“ˆ ç»Ÿè®¡æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          total=$((success_count + fail_count))
          if [ $total -gt 0 ]; then
            success_rate=$(awk "BEGIN {printf \"%.1f\", ($success_count / $total) * 100}")
          else
            success_rate="0.0"
          fi
          
          # æ ¼å¼åŒ–æ€»å¤§å°
          if [ $total_size -lt 1048576 ]; then
            total_size_kb=$((total_size / 1024))
            total_size_str="${total_size_kb} KB"
          else
            total_size_mb=$((total_size / 1048576))
            total_size_str="${total_size_mb} MB"
          fi
          
          echo "| æŒ‡æ ‡ | æ•°å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… **æˆåŠŸ** | $success_count |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ **å¤±è´¥** | $fail_count |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“Š **æ€»è®¡** | $total |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“ˆ **æˆåŠŸç‡** | ${success_rate}% |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ’¾ **æ€»äº§ç‰©å¤§å°** | $total_size_str |" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*ğŸ¤– ç”± GD32 Mirror CI è‡ªåŠ¨ç”Ÿæˆ*" >> $GITHUB_STEP_SUMMARY
          
          # ä¿å­˜ç»Ÿè®¡ä¿¡æ¯ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "SUCCESS_COUNT=$success_count" >> $GITHUB_ENV
          echo "FAIL_COUNT=$fail_count" >> $GITHUB_ENV
          echo "SUCCESS_RATE=$success_rate" >> $GITHUB_ENV
          
      - name: åœ¨PRä¸­è¯„è®ºæµ‹è¯•ç»“æœ
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |-
            const fs = require('fs');
            const path = require('path');
            
            let successCount = parseInt(process.env.SUCCESS_COUNT || '0');
            let failCount = parseInt(process.env.FAIL_COUNT || '0');
            let successRate = process.env.SUCCESS_RATE || '0.0';
            
            const results = [];
            const artifactsDir = 'artifacts';
            
            if (fs.existsSync(artifactsDir)) {
              const dirs = fs.readdirSync(artifactsDir);
              
              for (const dir of dirs) {
                const dirPath = path.join(artifactsDir, dir);
                if (!fs.statSync(dirPath).isDirectory()) continue;
                
                const [arch, ...bspParts] = dir.split('-');
                const bsp = bspParts.join('-');
                
                const binFile = path.join(dirPath, 'rtthread.bin');
                const elfFile = path.join(dirPath, 'rtthread.elf');
                
                if (fs.existsSync(binFile) || fs.existsSync(elfFile)) {
                  results.push(`| \`${arch}\` | \`${bsp}\` | âœ… æˆåŠŸ |`);
                } else {
                  results.push(`| \`${arch}\` | \`${bsp}\` | âŒ å¤±è´¥ |`);
                }
              }
            }
            
            const total = successCount + failCount;
            const libraryChanged = '${{ needs.analyze-changes.outputs.library_changed }}';
            const repoName = '${{ github.repository }}';
            
            const body = `## ğŸ”¨ GD32 BSP CIæµ‹è¯•ç»“æœ

### ğŸ“Š ç»Ÿè®¡æ‘˜è¦

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| âœ… æˆåŠŸ | ${successCount} |
| âŒ å¤±è´¥ | ${failCount} |
| ğŸ“Š æ€»è®¡ | ${total} |
| ğŸ“ˆ æˆåŠŸç‡ | ${successRate}% |
| ğŸ“š Librarieså˜æ›´ | ${libraryChanged} |

### ğŸ“‹ è¯¦ç»†ç»“æœ

| æ¶æ„ | BSP | çŠ¶æ€ |
|------|-----|------|
${results.join('\n')}

---
*ğŸ¤– è‡ªåŠ¨ç”Ÿæˆäº ${new Date().toISOString()} by [GD32 Mirror CI](https://github.com/${repoName})*`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
            
      - name: æ£€æŸ¥ç¼–è¯‘çŠ¶æ€
        run: |
          FAIL_COUNT=${{ env.FAIL_COUNT }}
          SUCCESS_COUNT=${{ env.SUCCESS_COUNT }}
          
          echo "========================================="
          echo "GD32 BSP CIæµ‹è¯•å®Œæˆ"
          echo "========================================="
          echo "âœ… æˆåŠŸ: $SUCCESS_COUNT"
          echo "âŒ å¤±è´¥: $FAIL_COUNT"
          echo "========================================="
          
          if [ "$FAIL_COUNT" -gt 0 ]; then
            echo ""
            echo "âš ï¸ æœ‰ $FAIL_COUNT ä¸ªBSPç¼–è¯‘å¤±è´¥"
            echo "è¯·æ£€æŸ¥ä¸Šè¿°æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
            exit 1
          else
            echo ""
            echo "ğŸ‰ æ‰€æœ‰BSPç¼–è¯‘æˆåŠŸï¼"
            exit 0
          fi


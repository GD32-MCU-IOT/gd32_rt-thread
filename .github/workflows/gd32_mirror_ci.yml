#
# Copyright (c) 2025, GD32-MCU-IOT Organization
#
# SPDX-License-Identifier: Apache-2.0
#
# GD32 Mirror Repository CI Workflow
# åŸºäº RT-Thread CI æ¡†æ¶ï¼Œä¸“ä¸º GD32 BSP ä¼˜åŒ–
# å¤ç”¨ tools/ci/bsp_buildings.py æ ¸å¿ƒç¼–è¯‘é€»è¾‘
#

name: GD32 BSP CI

on:
  # PR è§¦å‘ - è‡ªåŠ¨æ£€æµ‹å¹¶ç¼–è¯‘å—å½±å“çš„ GD32 BSP
  pull_request:
    branches:
      - master
    paths:
      - 'bsp/gd32/**'
      - 'components/**'
      - 'libcpu/**'
      - 'src/**'
      - 'include/**'
      - '!bsp/gd32/**/README*.md'
      - '!bsp/gd32/**/docs/**'
      - '.github/workflows/gd32_mirror_ci.yml'
      - 'bsp/gd32/scripts/gd32_bsp_config.json'
      
  # Push åˆ° master - è§¦å‘å…¨é‡æµ‹è¯•ï¼ˆå¯é€‰ï¼‰
  push:
    branches:
      - master
    paths:
      - 'bsp/gd32/**'
      - '.github/workflows/gd32_mirror_ci.yml'
      
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'æµ‹è¯•æ¨¡å¼'
        required: false
        default: 'all'
        type: choice
        options:
          - all        # ç¼–è¯‘æ‰€æœ‰ GD32 BSP
          - changed    # ä»…ç¼–è¯‘å˜æ›´çš„ BSP
      
# å¹¶å‘æ§åˆ¶
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  #============================================================================
  # Job 1: åˆ†æå˜æ›´å¹¶ç”Ÿæˆç¼–è¯‘çŸ©é˜µ
  #============================================================================
  generate-matrix:
    runs-on: ubuntu-22.04
    name: ğŸ” åˆ†æ GD32 BSP å˜æ›´
    # ä»…åœ¨ GD32-MCU-IOT ç»„ç»‡è¿è¡Œ
    if: github.repository_owner == 'GD32-MCU-IOT'
    outputs:
      filtered_matrix: ${{ steps.filter.outputs.filtered_matrix }}
      test_count: ${{ steps.filter.outputs.test_count }}
      
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@main
        with:
          # PR è§¦å‘æ—¶ checkout æºåˆ†æ”¯çš„ HEAD commit
          ref: ${{ github.event.pull_request.head.sha || github.ref }}
          persist-credentials: false
          fetch-depth: 0
      
      - name: ğŸ” è°ƒè¯•ï¼šéªŒè¯ checkout çŠ¶æ€
        shell: bash
        run: |
          echo "=== Checkout ä¿¡æ¯ ==="
          echo "Event: ${{ github.event_name }}"
          echo "Base Ref: ${{ github.base_ref }}"
          echo "Head Ref: ${{ github.head_ref }}"
          echo "Ref: ${{ github.ref }}"
          echo "SHA: ${{ github.sha }}"
          echo "PR Head SHA: ${{ github.event.pull_request.head.sha }}"
          echo ""
          echo "=== Git çŠ¶æ€ ==="
          git log -3 --oneline --graph
          git branch -a
          echo "å½“å‰ commit: $(git rev-parse HEAD)"
          echo ""
          echo "=== GD32 BSP ç›®å½•æ£€æŸ¥ ==="
          ls -la bsp/gd32/arm/ | head -15
      
      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@main
        with:
          python-version: '3.11'
      
      - name: æ£€æµ‹å˜æ›´å¹¶ç”ŸæˆçŸ©é˜µ
        id: filter
        run: |
          # è®¾ç½® git é…ç½®
          git config --global http.postBuffer 524288000
          git remote -v
          git fetch origin
          
          # ç¡®å®šåŸºå‡†åˆ†æ”¯
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_REF="origin/${{ github.base_ref }}"
          else
            BASE_REF="origin/master"
          fi
          
          echo "=== åŸºå‡†åˆ†æ”¯: $BASE_REF ==="
          
          # åˆ¤æ–­æµ‹è¯•æ¨¡å¼
          TEST_MODE="${{ github.event.inputs.test_mode }}"
          if [ -z "$TEST_MODE" ]; then
            if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
              TEST_MODE="all"
            else
              TEST_MODE="changed"
            fi
          fi
          
          echo "=== æµ‹è¯•æ¨¡å¼: $TEST_MODE ==="
          
          # âš ï¸ é‡è¦ï¼šgit_diff_show.py ä¼šè¯»å– ALL_BSP_COMPILE.json
          # æ‰€ä»¥éœ€è¦å…ˆæ›¿æ¢è¿™ä¸ªæ–‡ä»¶ä¸º GD32 é…ç½®
          cp bsp/gd32/scripts/gd32_bsp_config.json .github/ALL_BSP_COMPILE.json
          
          if [ "$TEST_MODE" = "changed" ]; then
            echo "=== ä½¿ç”¨æ™ºèƒ½å˜æ›´æ£€æµ‹ ==="
            
            # æ–¹å¼ 1: å¤ç”¨ RT-Thread git_diff_show.pyï¼ˆæ¨èï¼‰
            if [ -f "tools/ci/git_diff_show.py" ]; then
              # git_diff_show.py ä¼šè¯»å– ALL_BSP_COMPILE.json å¹¶ç”Ÿæˆ ALL_BSP_COMPILE_TEMP.json
              python tools/ci/git_diff_show.py $BASE_REF
              
              # æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†æ–‡ä»¶
              if [ ! -f ".github/ALL_BSP_COMPILE_TEMP.json" ]; then
                echo "âš ï¸ git_diff_show.py æœªç”Ÿæˆé…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨ GD32 å®Œæ•´é…ç½®"
                cp bsp/gd32/scripts/gd32_bsp_config.json .github/ALL_BSP_COMPILE_TEMP.json
              fi
            else
              # æ–¹å¼ 2: ç®€å•çš„ git diff æ£€æµ‹
              echo "âš ï¸ git_diff_show.py ä¸å­˜åœ¨ï¼Œä½¿ç”¨ç®€å•æ£€æµ‹"
              
              CHANGED_FILES=$(git diff --name-only $BASE_REF HEAD | grep "^bsp/gd32/" || true)
              
              if [ -z "$CHANGED_FILES" ]; then
                echo "â„¹ï¸ æœªæ£€æµ‹åˆ° GD32 å˜æ›´ï¼Œè·³è¿‡ç¼–è¯‘"
                echo '{"legs": []}' > .github/ALL_BSP_COMPILE_TEMP.json
              else
                echo "âœ… æ£€æµ‹åˆ° GD32 å˜æ›´ï¼Œç¼–è¯‘å…¨éƒ¨ GD32 BSP"
                echo "$CHANGED_FILES"
              fi
            fi
          else
            echo "=== ç¼–è¯‘æ‰€æœ‰ GD32 BSP ==="
            # all æ¨¡å¼ç›´æ¥ä½¿ç”¨ GD32 é…ç½®
            cp bsp/gd32/scripts/gd32_bsp_config.json .github/ALL_BSP_COMPILE_TEMP.json
          fi
          
          # è¯»å–æœ€ç»ˆé…ç½®
          raw_matrix=$(cat .github/ALL_BSP_COMPILE_TEMP.json)
          filtered_matrix=$(jq -c "{legs: [.legs[]]}" <<< "$raw_matrix")
          
          # ç»Ÿè®¡æµ‹è¯•æ•°é‡
          test_count=$(echo "$filtered_matrix" | jq '[.legs[].SUB_RTT_BSP[]] | length')
          
          echo "filtered_matrix=${filtered_matrix}" >> $GITHUB_OUTPUT
          echo "test_count=${test_count}" >> $GITHUB_OUTPUT
          
          echo "=== ç”Ÿæˆçš„ç¼–è¯‘çŸ©é˜µ ==="
          echo "$filtered_matrix" | jq .
          echo "=== æ€»æµ‹è¯•æ•°é‡: $test_count ==="
      
      - name: æ˜¾ç¤ºæµ‹è¯•è®¡åˆ’
        run: |
          echo "### ğŸ“‹ GD32 BSP ç¼–è¯‘è®¡åˆ’" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æµ‹è¯•æ•°é‡**: ${{ steps.filter.outputs.test_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ä»“åº“**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  #============================================================================
  # Job 2: å¹¶è¡Œç¼–è¯‘ GD32 BSP
  #============================================================================
  build-gd32:
    runs-on: ubuntu-22.04
    needs: generate-matrix
    name: ğŸ”¨ ç¼–è¯‘ ${{ matrix.legs.RTT_BSP }}
    if: needs.generate-matrix.outputs.test_count > 0
    
    strategy:
      fail-fast: false
      max-parallel: 5  # GD32 BSP å¹¶å‘ç¼–è¯‘æ•°
      matrix: ${{ fromJson(needs.generate-matrix.outputs.filtered_matrix) }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@main
        with:
          # ğŸ”¥ å…³é”®ä¿®å¤ï¼šä¸ generate-matrix job ä¿æŒä¸€è‡´çš„ checkout ç­–ç•¥
          ref: ${{ github.event.pull_request.head.sha || github.ref }}
          persist-credentials: false
          fetch-depth: 0
      
      - name: ğŸ” è°ƒè¯•ï¼šéªŒè¯ä»£ç ç›®å½•ç»“æ„
        shell: bash
        run: |
          echo "=== Checkout è¯¦ç»†ä¿¡æ¯ ==="
          echo "Event: ${{ github.event_name }}"
          echo "Repository: ${{ github.repository }}"
          echo "Actor: ${{ github.actor }}"
          echo "Ref: ${{ github.ref }}"
          echo "SHA: ${{ github.sha }}"
          echo "PR Head SHA: ${{ github.event.pull_request.head.sha }}"
          echo ""
          echo "=== Git çŠ¶æ€ ==="
          git log -3 --oneline --decorate
          echo "å½“å‰åˆ†æ”¯: $(git rev-parse --abbrev-ref HEAD)"
          echo "å½“å‰ commit: $(git rev-parse HEAD)"
          echo ""
          echo "=== æ£€æŸ¥å¾…ç¼–è¯‘çš„ BSP è·¯å¾„ ==="
          IFS=',' read -ra BSP_ARRAY <<< "${{ join(matrix.legs.SUB_RTT_BSP, ',') }}"
          for bsp in "${BSP_ARRAY[@]}"; do
            bsp_path="bsp/$bsp"
            if [ -d "$bsp_path" ]; then
              echo "âœ… ç›®å½•å­˜åœ¨: $bsp_path"
              ls -la "$bsp_path" | head -5
            else
              echo "âŒ ç›®å½•ä¸å­˜åœ¨: $bsp_path"
              echo "   åˆ—å‡ºçˆ¶ç›®å½•å†…å®¹:"
              parent_dir=$(dirname "$bsp_path")
              ls -la "$parent_dir" 2>/dev/null || echo "   çˆ¶ç›®å½•ä¹Ÿä¸å­˜åœ¨: $parent_dir"
            fi
            echo ""
          done
      
      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@main
        with:
          python-version: '3.11'
      
      - name: å®‰è£… RT-Thread Env å·¥å…·
        shell: bash
        run: |
          sudo apt-get update -qq
          wget https://raw.githubusercontent.com/RT-Thread/env/master/install_ubuntu.sh
          chmod 777 install_ubuntu.sh
          ./install_ubuntu.sh
          pip install -r tools/requirements.txt
          
          # ğŸ”¥ é…ç½® Git å‚æ•°
          git config --global advice.detachedHead false
          git config --global pull.rebase false
          git config --global core.fileMode false
          git config --global --add safe.directory '*'
          git config --global http.postBuffer 524288000
          
          echo "å½“å‰åˆ†æ”¯: $(git rev-parse --abbrev-ref HEAD)"
          echo "å½“å‰ commit: $(git rev-parse HEAD)"
          
          echo "RTT_ROOT=${{ github.workspace }}" >> $GITHUB_ENV
          echo "RTT_CC=gcc" >> $GITHUB_ENV
          echo "export PATH=~/.env/tools/scripts:$PATH" > ~/.env/env.sh

      #========================================================================
      # å·¥å…·é“¾å®‰è£… - ARM GCCï¼ˆGD32 ä¸»è¦ä½¿ç”¨ï¼‰
      #========================================================================
      - name: ç¼“å­˜ ARM å·¥å…·é“¾
        if: ${{ matrix.legs.RTT_TOOL_CHAIN == 'sourcery-arm' }}
        id: cache-gcc-arm
        uses: actions/cache@main
        with:
          path: /opt/arm-gnu-toolchain-13.2.Rel1-x86_64-arm-none-eabi
          key: ${{ runner.os }}-gcc-arm-13.2-rel1
          
      - name: ä¸‹è½½ ARM å·¥å…·é“¾
        if: ${{ matrix.legs.RTT_TOOL_CHAIN == 'sourcery-arm' && steps.cache-gcc-arm.outputs.cache-hit != 'true' }}
        shell: bash
        run: |
          wget -q https://github.com/RT-Thread/toolchains-ci/releases/download/v1.8/arm-gnu-toolchain-13.2.rel1-x86_64-arm-none-eabi.tar.xz
          sudo tar -xf arm-gnu-toolchain-13.2.rel1-x86_64-arm-none-eabi.tar.xz -C /opt
          
      - name: é…ç½® ARM å·¥å…·é“¾
        if: ${{ matrix.legs.RTT_TOOL_CHAIN == 'sourcery-arm' }}
        shell: bash
        run: |
          /opt/arm-gnu-toolchain-13.2.Rel1-x86_64-arm-none-eabi/bin/arm-none-eabi-gcc --version
          echo "RTT_EXEC_PATH=/opt/arm-gnu-toolchain-13.2.Rel1-x86_64-arm-none-eabi/bin" >> $GITHUB_ENV

      #========================================================================
      # æ ¸å¿ƒç¼–è¯‘æ­¥éª¤ - ä½¿ç”¨ Git Stash ä¿æŠ¤å·¥ä½œåŒº
      #========================================================================
      - name: ğŸ›¡ï¸ ä¿æŠ¤å·¥ä½œåŒºï¼ˆç¼–è¯‘å‰ï¼‰
        shell: bash
        run: |
          echo "=== ä¿æŠ¤å·¥ä½œåŒºå…å— pkgs Git æ“ä½œå½±å“ ==="
          
          # æ˜¾ç¤ºå½“å‰çŠ¶æ€
          echo "å½“å‰ Git çŠ¶æ€:"
          git status --short
          
          # ğŸ”¥ å…³é”®ï¼šä½¿ç”¨ git stash ä¿å­˜æ‰€æœ‰ä¿®æ”¹ï¼ˆåŒ…æ‹¬æœªè·Ÿè¸ªçš„æ–‡ä»¶ï¼‰
          # --include-untracked: ä¿å­˜æœªè·Ÿè¸ªçš„æ–‡ä»¶ï¼ˆæ–° BSP ç›®å½•ï¼‰
          # --keep-index: ä¿æŒæš‚å­˜åŒºä¸å˜
          git stash push --include-untracked --keep-index -m "CI: Protect BSP directories from pkgs operations" || true
          
          echo "âœ… å·¥ä½œåŒºå·²ä¿æŠ¤"
          echo ""
          echo "ä¿æŠ¤åçš„ Git çŠ¶æ€:"
          git status --short
      
      - name: ç¼–è¯‘ GD32 BSP
        if: ${{ success() }}
        shell: bash
        env:
          RTT_BSP: ${{ matrix.legs.RTT_BSP }}
          RTT_TOOL_CHAIN: ${{ matrix.legs.RTT_TOOL_CHAIN }}
          SRTT_BSP: ${{ join(matrix.legs.SUB_RTT_BSP, ',') }}
        run: |
          source ~/.env/env.sh
          
          echo "=== ç¼–è¯‘ç¯å¢ƒå˜é‡ ==="
          echo "RTT_ROOT=$RTT_ROOT"
          echo "RTT_CC=$RTT_CC"
          echo "RTT_EXEC_PATH=$RTT_EXEC_PATH"
          echo "RTT_BSP=$RTT_BSP"
          echo "SRTT_BSP=$SRTT_BSP"
          echo ""
          
          # ğŸ”¥ ä½¿ç”¨ GD32 è°ƒè¯•ç‰ˆç¼–è¯‘è„šæœ¬ï¼ˆæ‹¦æˆª os.chdir è°ƒç”¨ï¼‰
          python tools/ci/gd32_bsp_build_debug.py
      
      - name: ğŸ”“ æ¢å¤å·¥ä½œåŒºï¼ˆç¼–è¯‘åï¼‰
        if: always()
        shell: bash
        run: |
          echo "=== æ¢å¤å·¥ä½œåŒºçŠ¶æ€ ==="
          
          # ğŸ”¥ å…³é”®ï¼šæ¢å¤ stash çš„å†…å®¹
          # || true: å¦‚æœæ²¡æœ‰ stash å¯ä»¥ popï¼Œä¸æŠ¥é”™
          if git stash list | grep -q "CI: Protect BSP"; then
            echo "å‘ç°ä¿æŠ¤çš„ stashï¼Œæ­£åœ¨æ¢å¤..."
            git stash pop || {
              echo "âš ï¸ Stash pop å¤±è´¥ï¼Œå°è¯•å¼ºåˆ¶æ¢å¤"
              git stash apply
              git stash drop || true
            }
            echo "âœ… å·¥ä½œåŒºå·²æ¢å¤"
          else
            echo "â„¹ï¸ æ²¡æœ‰éœ€è¦æ¢å¤çš„ stash"
          fi
          
          echo ""
          echo "æ¢å¤åçš„ Git çŠ¶æ€:"
          git status --short

      #========================================================================
      # ä¸Šä¼ ç¼–è¯‘äº§ç‰©
      #========================================================================
      - name: ä¸Šä¼ ç¼–è¯‘äº§ç‰©
        if: ${{ success() }}
        uses: actions/upload-artifact@main
        with:
          name: gd32-${{ matrix.legs.RTT_BSP }}-${{ github.sha }}
          if-no-files-found: ignore
          retention-days: 7
          path: |
            output/**/*.elf
            output/**/*.bin
            output/**/*.hex
            output/**/*.map

      #========================================================================
      # å¤±è´¥å¤„ç†
      #========================================================================
      - name: ç¼–è¯‘å¤±è´¥æ—¶è¯„è®º PR
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `@${context.actor} âš ï¸ **GD32 BSP ç¼–è¯‘å¤±è´¥**\n\n**å¤±è´¥çš„ BSP**: \`${{ matrix.legs.RTT_BSP }}\`\n\nè¯·æ£€æŸ¥ç¼–è¯‘æ—¥å¿—å¹¶ä¿®å¤é”™è¯¯ã€‚`
            })

  #============================================================================
  # Job 3: æ”¶é›†æ‰€æœ‰ç¼–è¯‘äº§ç‰©ï¼ˆå¯é€‰ï¼‰
  #============================================================================
  collect-artifacts:
    needs: build-gd32
    runs-on: ubuntu-22.04
    if: success() && github.event_name != 'pull_request'
    name: ğŸ“¦ æ”¶é›†ç¼–è¯‘äº§ç‰©
    
    steps:
      - name: ä¸‹è½½æ‰€æœ‰ç¼–è¯‘äº§ç‰©
        uses: actions/download-artifact@main
        with:
          path: gd32-output/
          merge-multiple: true
      
      - name: åˆ—å‡ºäº§ç‰©
        run: |
          echo "=== ç¼–è¯‘äº§ç‰©åˆ—è¡¨ ==="
          ls -lhR gd32-output/
          
          echo "### ğŸ“¦ ç¼–è¯‘äº§ç‰©æ±‡æ€»" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -lhR gd32-output/ >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
      
      - name: ä¸Šä¼ åˆå¹¶äº§ç‰©
        uses: actions/upload-artifact@main
        with:
          name: gd32-all-bsp-${{ github.sha }}
          path: gd32-output/
          retention-days: 30

  #============================================================================
  # Job 4: å‘å¸ƒç¼–è¯‘æŠ¥å‘Šåˆ° PRï¼ˆå¯é€‰ï¼‰
  #============================================================================
  post-summary:
    needs: [generate-matrix, build-gd32]
    runs-on: ubuntu-22.04
    if: always() && github.event_name == 'pull_request'
    name: ğŸ“Š å‘å¸ƒç¼–è¯‘æŠ¥å‘Š
    
    steps:
      - name: ç”Ÿæˆç¼–è¯‘æŠ¥å‘Š
        uses: actions/github-script@main
        with:
          script: |
            const testCount = '${{ needs.generate-matrix.outputs.test_count }}';
            const buildResult = '${{ needs.build-gd32.result }}';
            
            let emoji = 'âœ…';
            let status = 'æˆåŠŸ';
            if (buildResult === 'failure') {
              emoji = 'âŒ';
              status = 'å¤±è´¥';
            } else if (buildResult === 'cancelled') {
              emoji = 'âš ï¸';
              status = 'å·²å–æ¶ˆ';
            }
            
            const body = `## ${emoji} GD32 BSP CI ç¼–è¯‘æŠ¥å‘Š
            
            - **æµ‹è¯•æ•°é‡**: ${testCount} ä¸ª BSP
            - **ç¼–è¯‘çŠ¶æ€**: ${status}
            - **è§¦å‘**: ${context.eventName}
            - **æäº¤**: ${context.sha.substring(0, 7)}
            
            ${buildResult === 'success' ? 'ğŸ‰ æ‰€æœ‰ GD32 BSP ç¼–è¯‘é€šè¿‡ï¼' : 'âš ï¸ éƒ¨åˆ†ç¼–è¯‘å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ã€‚'}
            `;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
